<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小红书导航器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }

        .content-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #ff6b6b;
            border-radius: 2px;
        }

        .cookie-section {
            margin-bottom: 30px;
        }

        .cookie-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .cookie-status.valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .cookie-status.invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cookie-status.unknown {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-outline {
            background: transparent;
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
        }

        .btn-outline:hover {
            background: #ff6b6b;
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .search-input-group {
            flex: 1;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .select-input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .note-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #e9ecef;
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .note-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            line-height: 1.4;
            cursor: pointer;
            text-decoration: none;
        }

        .note-title:hover {
            color: #ff6b6b;
        }

        .note-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .note-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .help-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        .cookie-guide {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .cookie-guide h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .cookie-guide ol {
            margin-left: 20px;
        }

        .cookie-guide li {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                position: static;
            }
            
            .search-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-controls {
                justify-content: stretch;
            }
            
            .btn-group {
                justify-content: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌸 小红书导航器</h1>
            <p>智能搜索与内容发现工具</p>
        </div>

        <div class="main-content">
            <!-- 侧边栏 - Cookie管理 -->
            <div class="sidebar">
                <div class="cookie-section">
                    <h2 class="section-title">🔐 Cookie 管理</h2>
                    
                    <div id="cookieStatus" class="cookie-status unknown">
                        Cookie 状态未知，请先测试或设置
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cookie 值</label>
                        <textarea 
                            id="cookieInput" 
                            class="form-input form-textarea" 
                            placeholder="请粘贴从小红书网站复制的完整 Cookie..."
                        ></textarea>
                        <div class="help-text">
                            从浏览器开发者工具中复制完整的 Cookie 字符串
                        </div>
                    </div>

                    <div class="btn-group">
                        <button onclick="saveCookie()" class="btn btn-primary">保存 Cookie</button>
                        <button onclick="testCookie()" class="btn btn-outline">测试 Cookie</button>
                        <button onclick="clearCookie()" class="btn btn-secondary">清除 Cookie</button>
                    </div>

                    <div class="cookie-guide">
                        <h4>📋 获取 Cookie 步骤：</h4>
                        <ol>
                            <li>打开小红书网站并登录</li>
                            <li>按 F12 打开开发者工具</li>
                            <li>切换到 Network 标签</li>
                            <li>刷新页面，找到任意请求</li>
                            <li>复制 Request Headers 中的 Cookie</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- 主内容区 - 搜索功能 -->
            <div class="content-area">
                <div class="search-section">
                    <h2 class="section-title">🔍 内容搜索</h2>
                    
                    <div class="search-form">
                        <div class="search-input-group">
                            <label class="form-label">搜索关键词</label>
                            <input 
                                type="text" 
                                id="searchKeyword" 
                                class="form-input" 
                                placeholder="输入要搜索的关键词..."
                                onkeypress="handleSearchKeyPress(event)"
                            >
                        </div>
                        
                        <div class="search-controls">
                            <div>
                                <label class="form-label">排序方式</label>
                                <select id="sortType" class="select-input">
                                    <option value="general">综合排序</option>
                                    <option value="most_popular">最热排序</option>
                                    <option value="latest">最新排序</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label">数量</label>
                                <select id="pageSize" class="select-input">
                                    <option value="10">10条</option>
                                    <option value="20" selected>20条</option>
                                    <option value="30">30条</option>
                                </select>
                            </div>
                            
                            <button onclick="searchNotes()" class="btn btn-primary">搜索</button>
                        </div>
                    </div>
                </div>

                <div class="results-section">
                    <div id="searchResults">
                        <div style="text-align: center; padding: 60px; color: #999;">
                            <h3>🎯 开始您的搜索之旅</h3>
                            <p>输入关键词，发现精彩内容</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cookie 管理功能
        function saveCookie() {
            const cookieValue = document.getElementById('cookieInput').value.trim();
            if (!cookieValue) {
                alert('请输入 Cookie 值');
                return;
            }
            
            localStorage.setItem('xhs_cookie', cookieValue);
            updateCookieStatus('valid', 'Cookie 已保存，状态良好');
            alert('Cookie 保存成功！');
        }

        function clearCookie() {
            localStorage.removeItem('xhs_cookie');
            document.getElementById('cookieInput').value = '';
            updateCookieStatus('unknown', 'Cookie 已清除');
            alert('Cookie 已清除！');
        }

        async function testCookie() {
            const cookieValue = localStorage.getItem('xhs_cookie');
            if (!cookieValue) {
                updateCookieStatus('invalid', '未找到 Cookie，请先设置');
                return;
            }

            updateCookieStatus('unknown', '正在测试 Cookie...');
            
            try {
                const response = await fetch('/api/xhs/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test_cookie',
                        cookie: cookieValue
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    updateCookieStatus('valid', 'Cookie 测试成功，可以正常使用');
                } else {
                    if (result.error && result.error.includes('-100')) {
                        updateCookieStatus('invalid', 'Cookie 已过期，请重新获取');
                    } else {
                        updateCookieStatus('invalid', `Cookie 测试失败: ${result.error || '未知错误'}`);
                    }
                }
            } catch (error) {
                updateCookieStatus('invalid', `测试失败: ${error.message}`);
            }
        }

        function updateCookieStatus(status, message) {
            const statusElement = document.getElementById('cookieStatus');
            statusElement.className = `cookie-status ${status}`;
            statusElement.textContent = message;
        }

        // 搜索功能
        async function searchNotes() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const sortType = document.getElementById('sortType').value;
            const pageSize = parseInt(document.getElementById('pageSize').value);
            
            if (!keyword) {
                alert('请输入搜索关键词');
                return;
            }

            const cookieValue = localStorage.getItem('xhs_cookie');
            if (!cookieValue) {
                alert('请先设置 Cookie');
                return;
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading">🔍 正在搜索中...</div>';

            try {
                const response = await fetch('/api/xhs/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'search',
                        keyword: keyword,
                        sort: sortType,
                        pageSize: pageSize,
                        cookie: cookieValue
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    if (result.error && result.error.includes('-100')) {
                        resultsContainer.innerHTML = `
                            <div class="error-message">
                                <h4>🔒 Cookie 已过期</h4>
                                <p>检测到登录状态已过期（错误代码：-100），请重新获取 Cookie。</p>
                                <p><strong>注意：</strong>小红书对电脑端访问有限制，建议使用手机扫码登录后再获取 Cookie。</p>
                            </div>
                        `;
                        updateCookieStatus('invalid', 'Cookie 已过期，请重新获取');
                    } else {
                        resultsContainer.innerHTML = `
                            <div class="error-message">
                                搜索失败: ${result.error || '未知错误'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!data.notes || data.notes.length === 0) {
                resultsContainer.innerHTML = '<div class="loading">😔 没有找到相关内容</div>';
                return;
            }

            const resultsHtml = `
                <h3 style="margin-bottom: 20px; color: #333;">
                    📊 搜索结果 (${data.notes.length} 条)
                </h3>
                <div class="results-grid">
                    ${data.notes.map(note => `
                        <div class="note-card">
                            <div class="note-title" onclick="copyNoteUrl('${note.note_id}')" title="点击复制链接">
                                ${note.title}
                            </div>
                            <div class="note-stats">
                                <span>👍 ${note.liked_count}</span>
                                <span>💬 ${note.comment_count}</span>
                                <span>⭐ ${note.collected_count}</span>
                            </div>
                            <div class="note-actions">
                                <button onclick="copyNoteUrl('${note.note_id}')" class="btn btn-outline" style="font-size: 12px; padding: 6px 12px;">
                                    📋 复制链接
                                </button>
                                <button onclick="openNoteWithTip('${note.note_id}')" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                                    📱 查看提示
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultsContainer.innerHTML = resultsHtml;
        }

        function copyNoteUrl(noteId) {
            const url = `https://www.xiaohongshu.com/explore/${noteId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('链接已复制到剪贴板！\n\n⚠️ 注意：由于小红书的访问限制，复制的链接可能需要在手机端打开。');
            }).catch(() => {
                prompt('请手动复制以下链接：', url);
            });
        }

        function openNoteWithTip(noteId) {
            const url = `https://www.xiaohongshu.com/explore/${noteId}`;
            alert(`📱 访问提示\n\n由于小红书的反爬虫机制，建议：\n\n1. 复制链接到手机浏览器打开\n2. 或使用小红书 App 扫码查看\n3. 电脑端可能显示"当前笔记暂时无法浏览"\n\n链接：${url}`);
        }

        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchNotes();
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            const savedCookie = localStorage.getItem('xhs_cookie');
            if (savedCookie) {
                document.getElementById('cookieInput').value = savedCookie;
                updateCookieStatus('unknown', 'Cookie 已加载，建议测试一下');
            }
        };
    </script>
</body>
</html>