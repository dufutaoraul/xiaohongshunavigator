# 数据库级联删除设置说明

## 🎯 **目标**
当在Supabase后台手动删除`users`表中的学员时，自动删除其他表中与该学员相关的所有数据。

## 📋 **需要设置级联删除的表**

### 1. **checkin_schedules** (打卡安排表)
- **外键字段**: `student_id`
- **引用**: `users.student_id`
- **级联删除**: 删除用户时自动删除其打卡安排

### 2. **checkin_records** (打卡记录表)
- **外键字段**: `student_id`
- **引用**: `users.student_id`
- **级联删除**: 删除用户时自动删除其打卡记录

### 3. **homework_submissions** (作业提交表)
- **外键字段**: `student_id`
- **引用**: `users.student_id`
- **级联删除**: 删除用户时自动删除其作业提交

### 4. **homework_grades** (作业评分表)
- **外键字段**: `student_id`
- **引用**: `users.student_id`
- **级联删除**: 删除用户时自动删除其作业评分

## 🔧 **在Supabase后台设置步骤**

### 方法1：通过SQL编辑器设置

1. **登录Supabase后台**
2. **进入SQL编辑器**
3. **执行以下SQL语句**：

```sql
-- 1. 删除现有的外键约束
ALTER TABLE checkin_schedules DROP CONSTRAINT IF EXISTS checkin_schedules_student_id_fkey;
ALTER TABLE checkin_records DROP CONSTRAINT IF EXISTS checkin_records_student_id_fkey;
ALTER TABLE homework_submissions DROP CONSTRAINT IF EXISTS homework_submissions_student_id_fkey;
ALTER TABLE homework_grades DROP CONSTRAINT IF EXISTS homework_grades_student_id_fkey;

-- 2. 创建新的级联删除约束
ALTER TABLE checkin_schedules 
ADD CONSTRAINT checkin_schedules_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;

ALTER TABLE checkin_records 
ADD CONSTRAINT checkin_records_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;

ALTER TABLE homework_submissions 
ADD CONSTRAINT homework_submissions_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;

ALTER TABLE homework_grades 
ADD CONSTRAINT homework_grades_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;
```

### 方法2：通过表编辑器设置

1. **进入Database > Tables**
2. **选择要设置的表**（如`checkin_schedules`）
3. **点击表结构编辑**
4. **找到`student_id`字段**
5. **编辑外键约束**
6. **设置`ON DELETE`为`CASCADE`**
7. **重复以上步骤设置其他表**

## ✅ **验证设置是否成功**

执行以下SQL查询验证约束是否正确设置：

```sql
SELECT 
    tc.table_name, 
    kcu.column_name, 
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name,
    tc.constraint_name,
    rc.delete_rule
FROM 
    information_schema.table_constraints AS tc 
    JOIN information_schema.key_column_usage AS kcu
      ON tc.constraint_name = kcu.constraint_name
    JOIN information_schema.constraint_column_usage AS ccu
      ON ccu.constraint_name = tc.constraint_name
    JOIN information_schema.referential_constraints AS rc
      ON tc.constraint_name = rc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND ccu.table_name = 'users'
  AND rc.delete_rule = 'CASCADE';
```

## 🧪 **测试级联删除**

1. **创建测试学员**：
```sql
INSERT INTO users (student_id, name, can_self_schedule, has_used_self_schedule)
VALUES ('TEST_DELETE', '测试删除用户', false, false);
```

2. **创建测试数据**：
```sql
INSERT INTO checkin_schedules (student_id, start_date, end_date, schedule_type, is_active, created_by)
VALUES ('TEST_DELETE', '2025-01-01', '2025-04-04', 'admin_set', true, 'system');
```

3. **删除测试用户**：
```sql
DELETE FROM users WHERE student_id = 'TEST_DELETE';
```

4. **验证相关数据是否被删除**：
```sql
SELECT * FROM checkin_schedules WHERE student_id = 'TEST_DELETE';
-- 应该返回0条记录
```

## 🎉 **设置完成后的效果**

- ✅ **自动清理**：删除用户时自动删除所有相关数据
- ✅ **数据一致性**：避免孤立数据残留
- ✅ **管理便捷**：后台删除用户更简单
- ⚠️ **不可逆**：删除操作无法撤销，请谨慎操作

## 📝 **注意事项**

1. **备份重要数据**：删除前请确保重要数据已备份
2. **谨慎操作**：级联删除是不可逆的
3. **权限控制**：确保只有管理员能删除用户
4. **日志记录**：建议记录删除操作日志

## 🔍 **技术原理**

**CASCADE DELETE** 是PostgreSQL的外键约束选项：
- **CASCADE**: 删除父表记录时，自动删除子表中的相关记录
- **RESTRICT**: 如果子表中有相关记录，阻止删除父表记录
- **SET NULL**: 删除父表记录时，将子表中的外键字段设为NULL
- **SET DEFAULT**: 删除父表记录时，将子表中的外键字段设为默认值
- **NO ACTION**: 类似RESTRICT，但可以延迟检查

我们选择**CASCADE**是因为：
- 学员数据应该是完整的单元
- 删除学员时，其相关的打卡、作业数据也应该被清理
- 避免数据库中残留孤立数据
