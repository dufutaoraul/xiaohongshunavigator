# æ•°æ®åº“çº§è”åˆ é™¤è®¾ç½®è¯´æ˜

## ğŸ¯ **ç›®æ ‡**
å½“åœ¨Supabaseåå°æ‰‹åŠ¨åˆ é™¤`users`è¡¨ä¸­çš„å­¦å‘˜æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…¶ä»–è¡¨ä¸­ä¸è¯¥å­¦å‘˜ç›¸å…³çš„æ‰€æœ‰æ•°æ®ã€‚

## ğŸ“‹ **éœ€è¦è®¾ç½®çº§è”åˆ é™¤çš„è¡¨**

### 1. **checkin_schedules** (æ‰“å¡å®‰æ’è¡¨)
- **å¤–é”®å­—æ®µ**: `student_id`
- **å¼•ç”¨**: `users.student_id`
- **çº§è”åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å…¶æ‰“å¡å®‰æ’

### 2. **checkin_records** (æ‰“å¡è®°å½•è¡¨)
- **å¤–é”®å­—æ®µ**: `student_id`
- **å¼•ç”¨**: `users.student_id`
- **çº§è”åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å…¶æ‰“å¡è®°å½•

### 3. **homework_submissions** (ä½œä¸šæäº¤è¡¨)
- **å¤–é”®å­—æ®µ**: `student_id`
- **å¼•ç”¨**: `users.student_id`
- **çº§è”åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å…¶ä½œä¸šæäº¤

### 4. **homework_grades** (ä½œä¸šè¯„åˆ†è¡¨)
- **å¤–é”®å­—æ®µ**: `student_id`
- **å¼•ç”¨**: `users.student_id`
- **çº§è”åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å…¶ä½œä¸šè¯„åˆ†

## ğŸ”§ **åœ¨Supabaseåå°è®¾ç½®æ­¥éª¤**

### æ–¹æ³•1ï¼šé€šè¿‡SQLç¼–è¾‘å™¨è®¾ç½®

1. **ç™»å½•Supabaseåå°**
2. **è¿›å…¥SQLç¼–è¾‘å™¨**
3. **æ‰§è¡Œä»¥ä¸‹SQLè¯­å¥**ï¼š

```sql
-- 1. åˆ é™¤ç°æœ‰çš„å¤–é”®çº¦æŸ
ALTER TABLE checkin_schedules DROP CONSTRAINT IF EXISTS checkin_schedules_student_id_fkey;
ALTER TABLE checkin_records DROP CONSTRAINT IF EXISTS checkin_records_student_id_fkey;
ALTER TABLE homework_submissions DROP CONSTRAINT IF EXISTS homework_submissions_student_id_fkey;
ALTER TABLE homework_grades DROP CONSTRAINT IF EXISTS homework_grades_student_id_fkey;

-- 2. åˆ›å»ºæ–°çš„çº§è”åˆ é™¤çº¦æŸ
ALTER TABLE checkin_schedules 
ADD CONSTRAINT checkin_schedules_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;

ALTER TABLE checkin_records 
ADD CONSTRAINT checkin_records_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;

ALTER TABLE homework_submissions 
ADD CONSTRAINT homework_submissions_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;

ALTER TABLE homework_grades 
ADD CONSTRAINT homework_grades_student_id_fkey 
FOREIGN KEY (student_id) REFERENCES users(student_id) ON DELETE CASCADE;
```

### æ–¹æ³•2ï¼šé€šè¿‡è¡¨ç¼–è¾‘å™¨è®¾ç½®

1. **è¿›å…¥Database > Tables**
2. **é€‰æ‹©è¦è®¾ç½®çš„è¡¨**ï¼ˆå¦‚`checkin_schedules`ï¼‰
3. **ç‚¹å‡»è¡¨ç»“æ„ç¼–è¾‘**
4. **æ‰¾åˆ°`student_id`å­—æ®µ**
5. **ç¼–è¾‘å¤–é”®çº¦æŸ**
6. **è®¾ç½®`ON DELETE`ä¸º`CASCADE`**
7. **é‡å¤ä»¥ä¸Šæ­¥éª¤è®¾ç½®å…¶ä»–è¡¨**

## âœ… **éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸ**

æ‰§è¡Œä»¥ä¸‹SQLæŸ¥è¯¢éªŒè¯çº¦æŸæ˜¯å¦æ­£ç¡®è®¾ç½®ï¼š

```sql
SELECT 
    tc.table_name, 
    kcu.column_name, 
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name,
    tc.constraint_name,
    rc.delete_rule
FROM 
    information_schema.table_constraints AS tc 
    JOIN information_schema.key_column_usage AS kcu
      ON tc.constraint_name = kcu.constraint_name
    JOIN information_schema.constraint_column_usage AS ccu
      ON ccu.constraint_name = tc.constraint_name
    JOIN information_schema.referential_constraints AS rc
      ON tc.constraint_name = rc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND ccu.table_name = 'users'
  AND rc.delete_rule = 'CASCADE';
```

## ğŸ§ª **æµ‹è¯•çº§è”åˆ é™¤**

1. **åˆ›å»ºæµ‹è¯•å­¦å‘˜**ï¼š
```sql
INSERT INTO users (student_id, name, can_self_schedule, has_used_self_schedule)
VALUES ('TEST_DELETE', 'æµ‹è¯•åˆ é™¤ç”¨æˆ·', false, false);
```

2. **åˆ›å»ºæµ‹è¯•æ•°æ®**ï¼š
```sql
INSERT INTO checkin_schedules (student_id, start_date, end_date, schedule_type, is_active, created_by)
VALUES ('TEST_DELETE', '2025-01-01', '2025-04-04', 'admin_set', true, 'system');
```

3. **åˆ é™¤æµ‹è¯•ç”¨æˆ·**ï¼š
```sql
DELETE FROM users WHERE student_id = 'TEST_DELETE';
```

4. **éªŒè¯ç›¸å…³æ•°æ®æ˜¯å¦è¢«åˆ é™¤**ï¼š
```sql
SELECT * FROM checkin_schedules WHERE student_id = 'TEST_DELETE';
-- åº”è¯¥è¿”å›0æ¡è®°å½•
```

## ğŸ‰ **è®¾ç½®å®Œæˆåçš„æ•ˆæœ**

- âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šåˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
- âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šé¿å…å­¤ç«‹æ•°æ®æ®‹ç•™
- âœ… **ç®¡ç†ä¾¿æ·**ï¼šåå°åˆ é™¤ç”¨æˆ·æ›´ç®€å•
- âš ï¸ **ä¸å¯é€†**ï¼šåˆ é™¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ

## ğŸ“ **æ³¨æ„äº‹é¡¹**

1. **å¤‡ä»½é‡è¦æ•°æ®**ï¼šåˆ é™¤å‰è¯·ç¡®ä¿é‡è¦æ•°æ®å·²å¤‡ä»½
2. **è°¨æ…æ“ä½œ**ï¼šçº§è”åˆ é™¤æ˜¯ä¸å¯é€†çš„
3. **æƒé™æ§åˆ¶**ï¼šç¡®ä¿åªæœ‰ç®¡ç†å‘˜èƒ½åˆ é™¤ç”¨æˆ·
4. **æ—¥å¿—è®°å½•**ï¼šå»ºè®®è®°å½•åˆ é™¤æ“ä½œæ—¥å¿—

## ğŸ” **æŠ€æœ¯åŸç†**

**CASCADE DELETE** æ˜¯PostgreSQLçš„å¤–é”®çº¦æŸé€‰é¡¹ï¼š
- **CASCADE**: åˆ é™¤çˆ¶è¡¨è®°å½•æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å­è¡¨ä¸­çš„ç›¸å…³è®°å½•
- **RESTRICT**: å¦‚æœå­è¡¨ä¸­æœ‰ç›¸å…³è®°å½•ï¼Œé˜»æ­¢åˆ é™¤çˆ¶è¡¨è®°å½•
- **SET NULL**: åˆ é™¤çˆ¶è¡¨è®°å½•æ—¶ï¼Œå°†å­è¡¨ä¸­çš„å¤–é”®å­—æ®µè®¾ä¸ºNULL
- **SET DEFAULT**: åˆ é™¤çˆ¶è¡¨è®°å½•æ—¶ï¼Œå°†å­è¡¨ä¸­çš„å¤–é”®å­—æ®µè®¾ä¸ºé»˜è®¤å€¼
- **NO ACTION**: ç±»ä¼¼RESTRICTï¼Œä½†å¯ä»¥å»¶è¿Ÿæ£€æŸ¥

æˆ‘ä»¬é€‰æ‹©**CASCADE**æ˜¯å› ä¸ºï¼š
- å­¦å‘˜æ•°æ®åº”è¯¥æ˜¯å®Œæ•´çš„å•å…ƒ
- åˆ é™¤å­¦å‘˜æ—¶ï¼Œå…¶ç›¸å…³çš„æ‰“å¡ã€ä½œä¸šæ•°æ®ä¹Ÿåº”è¯¥è¢«æ¸…ç†
- é¿å…æ•°æ®åº“ä¸­æ®‹ç•™å­¤ç«‹æ•°æ®
